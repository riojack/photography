<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css?family=Heebo:100,300" rel="stylesheet">
  <meta charset="UTF-8">
  <title>Photography</title>
  <style type="text/css">
    html, body {
      height: 100%;
      width: 100%;
      padding: 0;
      margin: 0;
      background-color: #18577f;
      font-family: 'Heebo', Arial, sans-serif;
      color: rgba(255, 255, 255, .9);
    }
  </style>
</head>
<body>
<div id="photography-app-container"></div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.0/react.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.0/react-dom.js"></script>
<script type="text/javascript" src="./data.min.js"></script>
<script type="text/javascript" src="./support.min.js"></script>
<script type="text/javascript" src="./application.min.js"></script>
<script type="text/javascript">
  (function () {
    var mergeAppState = function () {
      },
      mergeNavState = function () {
      },
      mergeThumbState = function () {
      },
      mergeWorldState = function () {
      },
      mergeScaleState = function () {
      },
      mergeChalkboard = function () {
      };

    function containImageInBox(image, box) {
      var containedImageDimensions = {height: image.height, width: image.width};

      if (image.height > box.height) {
        containedImageDimensions.height = box.height;
        containedImageDimensions.width = (box.height / image.height) * image.width;
      }
      else if (image.width > box.width) {
        containedImageDimensions.width = box.width;
        containedImageDimensions.height = (box.width / image.width) * image.height;
      }

      return containedImageDimensions;
    }

    mergeAppState = window.Snappy.stateUtilities.stator.bind({
      state: {
        crumbs: ['Groups'],
        selectedGroup: false,
        selectedCollection: false
      }
    });
    mergeNavState = window.Snappy.stateUtilities.stator.bind({state: {groups: []}});
    mergeThumbState = window.Snappy.stateUtilities.stator.bind({state: {image: null, collection: []}});
    mergeWorldState = window.Snappy.stateUtilities.stator.bind({
      state: {
        tap: 'untapped',
        navState: mergeNavState(),
        thumbState: mergeThumbState(),
        application: mergeAppState()
      }
    });
    mergeScaleState = window.Snappy.stateUtilities.statorWithReset.bind({state: false});
    mergeChalkboard = window.Snappy.stateUtilities.stator.bind({collectionScrollY: 0});

    mergeScaleState({scale: window.Snappy.imageUtilities.scale.LARGE_SCALE});

    function render() {
      var container = document.getElementById('photography-app-container');

      return window.Snappy.render(container, mergeWorldState({
        tap: 'untapped',
        navState: mergeNavState(),
        thumbState: mergeThumbState(),
        application: mergeAppState()
      }));
    }

    function getViewportDimensions() {
      return {
        height: window.innerHeight,
        width: window.innerWidth
      };
    }

    function getGroupCrumb(group) {
      return group.group + ' collections';
    }

    function getCollectionCrumb(collection) {
      return collection.collection + ' photographs';
    }

    function getPhotographCrumb() {
      return 'Photograph';
    }

    function buildCrumbs(appState) {
      var crumbs = ['Groups'];

      if (appState.selectedGroup) {
        crumbs.push(getGroupCrumb(appState.selectedGroup));
      }

      if (appState.selectedCollection) {
        crumbs.push(getCollectionCrumb(appState.selectedCollection));
      }

      if (appState.image) {
        crumbs.push(getPhotographCrumb());
      }

      return crumbs;
    }

    function whenShouldViewThumbnail(item) {
      mergeAppState({
        imageObject: item,
        image: window.SnappySupport.texticons.loading[0],
        imageAttributes: {
          height: 100,
          width: 500,
          isLoading: true
        }
      });

      mergeChalkboard({
        collectionScrollY: window.scrollY
      });

      render();

      var image = new Image();
      image.src = item.image;
      image.onload = function () {
        var currentScale = mergeScaleState().scale,
          viewport = getViewportDimensions(),
          imageObject = Object.assign({}, item, {height: this.height, width: this.width}),
          fittedImageObject = containImageInBox(imageObject, viewport);

        mergeScaleState({scale: window.Snappy.imageUtilities.previousScale(currentScale)});

        mergeAppState({
          imageObject: fittedImageObject,
          image: item.image
        });

        mergeAppState({crumbs: buildCrumbs(mergeAppState())});

        whenShouldResizeImage();
      };
    }

    function whenShouldNavigateToCollection(collection) {
      mergeAppState({
        selectedCollection: collection,
        imageObject: null,
        image: null
      });
      mergeAppState({crumbs: buildCrumbs(mergeAppState())});
      mergeThumbState({collection: collection.items});
      render();
    }

    function whenShouldNavigateToGroup(group) {
      mergeAppState({selectedGroup: group});
      mergeAppState({crumbs: buildCrumbs(mergeAppState())});
      render();
    }

    function whenShouldReturnToGroups() {
      mergeAppState({selectedGroup: false});
      render();
    }

    function whenShouldResizeImage() {
      var scaleState = mergeScaleState(),
        currentScale = scaleState.scale,
        nextScale = window.Snappy.imageUtilities.nextScale(currentScale),
        pristineImage = mergeAppState().imageObject;

      mergeScaleState({scale: nextScale});

      mergeAppState({
        imageAttributes: window.Snappy.imageUtilities.nextScaleOfImage(currentScale, pristineImage)
      });

      render();
    }

    function whenCrumbClicked(crumb) {
      var appState = mergeAppState(),
        indexOfCrumb = appState.crumbs.indexOf(crumb);

      if (indexOfCrumb < 0) {
        return;
      }

      if (crumb === 'Groups') {
        appState.selectedGroup = null;
        appState.selectedCollection = null;
        appState.imageObject = null;
        appState.image = null;
      }
      else if (crumb === getGroupCrumb(appState.selectedGroup)) {
        appState.selectedCollection = null;
        appState.imageObject = null;
        appState.image = null;
      }
      else if (crumb === getCollectionCrumb(appState.selectedCollection)) {
        appState.imageObject = null;
        appState.image = null;
      }

      mergeAppState(appState);

      mergeAppState({crumbs: buildCrumbs(mergeAppState())});
      render()
        .then(function () {
          window.scrollTo(0, mergeChalkboard().collectionScrollY);
        });
    }

    function whenShouldViewPhotoInNewTab() {
      var appState = mergeAppState();

      window.open(appState.image, 'photo-viewer-new-tab');
    }

    function snappyDataComparator(left, right) {
      var leftLatestCollection = left.collections.reduce(function (pv, cv) {
          if (cv.time >= pv.time) {
            return cv;
          }
          return pv;
        }),
        rightLatestCollection = right.collections.reduce(function (pv, cv) {
          if (cv.time >= pv.time) {
            return cv;
          }
          return pv;
        });

      if (leftLatestCollection.time > rightLatestCollection.time) {
        return -1;
      }
      return 1;
    }

    // start up
    mergeAppState({
      selectedGroup: false,
      selectedCollection: false,

      onCollectionClick: whenShouldNavigateToCollection,
      onGroupClick: whenShouldNavigateToGroup,
      onViewGroupsClick: whenShouldReturnToGroups,
      onThumbClick: whenShouldViewThumbnail,
      onImageClick: whenShouldResizeImage,
      onCrumbClick: whenCrumbClicked,
      onViewPhoto: whenShouldViewPhotoInNewTab
    });

    window.SnappyData.sort(snappyDataComparator);

    mergeNavState({
      groups: window.SnappyData
    });

    render();
  }());
</script>
</body>
</html>
